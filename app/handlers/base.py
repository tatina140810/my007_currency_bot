from telegram import Update
from telegram.ext import ContextTypes
from app.core.logger import logger
from app.db.instance import db
from app.handlers.utils import get_chat_name, get_chat_id

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    chat = update.effective_chat
    
    if not user or not chat:
        return

    chat_name = get_chat_name(update)
    telegram_chat_name = chat.title or chat.first_name or f"–ß–∞—Ç {chat.id}"
    db.register_chat(chat.id, telegram_chat_name, chat.type)

    base_text = f"""–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!

–¢–µ–∫—É—â–∏–π —á–∞—Ç: {chat_name}

–ö–æ–º–∞–Ω–¥—ã:
/bal - –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å
/his - –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
/del - –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é (–ø–æ –ø–∞—Ä–æ–ª—é)
/ex - –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
/help - –°–ø—Ä–∞–≤–∫–∞

–û–ø–µ—Ä–∞—Ü–∏–∏ –≤ —á–∞—Ç–µ (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤):
- –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è: "... 1000,00 —Ä—É–± –ø–æ—Å—Ç—É–ø–∏–ª–∏ ..."
- –í–∑–Ω–æ—Å: "–≤–∑–Ω–æ—Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ 5000 usd"
- –í—ã–¥–∞—á–∞: "–≤—ã–¥–∞—á–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ 3000 usd"
- –í–æ–∑–≤—Ä–∞—Ç: "–≤–æ–∑–≤—Ä–∞—Ç 1000 usd"

–í –ª–∏—á–Ω–æ–º —á–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π [–ì–†–£–ü–ü–ê]:
[–£–ó] –ø–æ—Å—Ç—É–ø–∏–ª–∏ 5000 usdt
"""
    await update.message.reply_text(base_text, parse_mode=None)


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_name = get_chat_name(update)

    help_text = f"""üìå –°–ü–†–ê–í–ö–ê
–¢–µ–∫—É—â–∏–π —á–∞—Ç: {chat_name}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
/bal ‚Äî –ë–∞–ª–∞–Ω—Å (–ø–æ —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø–µ)
/his ‚Äî –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (–∑–∞ —Å–µ–≥–æ–¥–Ω—è)
/his 01.12.2025 ‚Äî –ò—Å—Ç–æ—Ä–∏—è –∑–∞ –¥–∞—Ç—É
/del ‚Äî –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é (–ø–æ –ø–∞—Ä–æ–ª—é)
/ex ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (–≤—Å—è –∏—Å—Ç–æ—Ä–∏—è)
/ex —Å–µ–≥–æ–¥–Ω—è ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è
/rep ‚Äî –û—Ç—á–µ—Ç (—Ç–µ–∫—Å—Ç–æ–≤—ã–π)
/sum ‚Äî –°—É–º–º–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (—Ñ–æ—Ä–º–∞—Ç: /sum 01.01.2025-31.01.2025)
/help ‚Äî –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä –ö–ê–°–°–û–í–´–ô –û–¢–ß–ï–¢ (–í –õ–ò–ß–ö–ï)
/cash_open ‚Äî –í–≤–æ–¥ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞
/cash_report ‚Äî –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel)
/set_rate ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å –æ–±–º–µ–Ω–∞ (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)
/cash_exchange ‚Äî –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–±–º–µ–Ω (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîß –ê–î–ú–ò–ù / –°–û–¢–†–£–î–ù–ò–ö–ò
/allbal ‚Äî –ë–∞–ª–∞–Ω—Å –ø–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º
/chats ‚Äî –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥—Ä—É–ø–ø
/clear ‚Äî –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã (–û–ü–ê–°–ù–û!)
/cancel ‚Äî –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ –ö–ê–ö –î–û–ë–ê–í–õ–Ø–¢–¨ –û–ü–ï–†–ê–¶–ò–ò (—Ç–æ–ª—å–∫–æ staff)

1) –ê–≤—Ç–æ-–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–±–∞–Ω–∫)
–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –±–∞–Ω–∫–∞, –±–æ—Ç —Å–∞–º —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç ¬´–ø–æ—Å—Ç—É–ø–∏–ª–∏ / –∑–∞—á–∏—Å–ª–µ–Ω–æ¬ª –∏ —Å—É–º–º—É.
–í –ª–∏—á–∫–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞—Ç—å –≥—Ä—É–ø–ø—É:
[–£–ó] –ø–æ—Å—Ç—É–ø–∏–ª–∏ 5000 usdt

2) –†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤ –ª–∏—á–∫–µ —É–∫–∞–∑—ã–≤–∞—Ç—å [–ì–†–£–ü–ü–ê])
[–£–ó] –ø–æ—Å—Ç—É–ø–∏–ª–∏ 5000 usdt
[–£–ó] –≤–∑–Ω–æ—Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ 1000 usd
[–£–ó] –≤—ã–¥–∞—á–∞ 2000 usd
[–£–ó] –æ–ø–ª–∞—Ç–∞ –ø–ø 1500 usd
[–£–ó] —Ö–∞—Ä–±–æ—Ä –∫–æ–º–∏—Å—Å–∏—è 50 usd
[–£–ó] –∑–∞–ø—Ä–æ—Å –±–∞–Ω–∫—É 65 usd

3) –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (—Ñ–∏–∫—Å/–æ—Ç–∫—É–ø)
–§–æ—Ä–º–∞—Ç:
[–£–ó] —Ñ–∏–∫—Å 140000 cny 11.4 rub
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–æ—Ç:
+140000 CNY
-(140000 * 11.4) RUB

4) –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–±–º–µ–Ω (Cash Report):
/cash_exchange [–ì—Ä—É–ø–ø–∞] 100 USD to RUB

5) –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—á–µ—Ç ([internal_report]):
- –ü–æ–∫—É–ø–∫–∞ (Buy FX):
[internal_report] 69000 EUR 91.8
(–†–µ–∑—É–ª—å—Ç–∞—Ç: +69000 EUR, -RUB –ø–æ –∫—É—Ä—Å—É)

- –í—ã–¥–∞—á–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö (Cash Out):
[internal_report] –Ω–∞–ª–∏—á–Ω—ã–µ 5000 USD
(–†–µ–∑—É–ª—å—Ç–∞—Ç: -5000 USD)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí± –í–∞–ª—é—Ç—ã:
USD, EUR, RUB, CNY, KGS, KZT, USDT, AED
"""
    await update.message.reply_text(help_text, parse_mode=None)


async def cancel_any(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /cancel"""
    if "pending_undo_op_id" in context.user_data:
        context.user_data.pop("pending_undo_op_id", None)
        context.user_data.pop("pending_undo_chat_id", None)
        await update.message.reply_text("–û—Ç–º–µ–Ω–µ–Ω–æ", parse_mode=None)
        return
    await update.message.reply_text("–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å.", parse_mode=None)


async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
    logger.exception("Unhandled exception", exc_info=context.error)
