# 🏗️ Архитектура бота

## Структура проекта

```
currency_bot/
│
├── 📄 bot.py                      # Главный файл - Telegram бот
│   ├── CommandHandler             # Обработка команд (/start, /balance, etc.)
│   ├── ConversationHandler        # Диалоги добавления операций
│   ├── CallbackQueryHandler       # Обработка нажатий кнопок
│   └── MessageHandler             # Обработка текстовых сообщений
│
├── 🗄️ database.py                 # Работа с базой данных
│   ├── create_tables()            # Создание таблиц
│   ├── add_operation()            # Добавление операции
│   ├── get_balances()             # Получение балансов
│   ├── get_operations()           # История операций
│   ├── get_statistics()           # Статистика
│   └── recalculate_balances()     # Пересчет балансов
│
├── ⚙️ config.py                   # Конфигурация
│   ├── BOT_TOKEN                  # Токен бота
│   ├── CURRENCIES                 # Список валют
│   ├── OPERATION_TYPES            # Типы операций
│   └── DATABASE_NAME              # Имя файла БД
│
├── 📦 requirements.txt            # Зависимости Python
├── 📚 README.md                   # Полная документация
├── 🚀 QUICKSTART.md               # Быстрый старт
├── 🔧 install.sh                  # Скрипт установки
├── 🧪 test_database.py            # Тесты базы данных
├── 📊 export_data.py              # Экспорт в CSV
├── 📝 .gitignore                  # Исключения для Git
├── 📋 config.example.py           # Пример конфигурации
│
└── 💾 currency_operations.db     # База данных SQLite (создается автоматически)
```

## Схема работы

```
┌─────────────────┐
│   Пользователь  │
│    Telegram     │
└────────┬────────┘
         │
         ↓
┌─────────────────────────────────────────┐
│           bot.py (Telegram Bot)         │
│  ┌───────────────────────────────────┐  │
│  │  Command Handlers                 │  │
│  │  • /start - Приветствие           │  │
│  │  • /balance - Показать балансы    │  │
│  │  • /add - Добавить операцию       │  │
│  │  • /history - История             │  │
│  │  • /stats - Статистика            │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  Conversation Handler             │  │
│  │  1. Выбор типа операции           │  │
│  │  2. Выбор валюты                  │  │
│  │  3. Ввод суммы                    │  │
│  │  4. Ввод курса (для конвертации)  │  │
│  │  5. Ввод описания                 │  │
│  └───────────────────────────────────┘  │
└────────────┬────────────────────────────┘
             │
             ↓
┌─────────────────────────────────────────┐
│      database.py (Database Layer)       │
│  ┌───────────────────────────────────┐  │
│  │  Operations                       │  │
│  │  • add_operation()                │  │
│  │  • get_operations()               │  │
│  │  • delete_operation()             │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  Balances                         │  │
│  │  • get_balances()                 │  │
│  │  • get_balance(currency)          │  │
│  │  • recalculate_balances()         │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  Statistics                       │  │
│  │  • get_statistics()               │  │
│  │  • get_total_operations_count()   │  │
│  └───────────────────────────────────┘  │
└────────────┬────────────────────────────┘
             │
             ↓
┌─────────────────────────────────────────┐
│   currency_operations.db (SQLite)       │
│  ┌───────────────────────────────────┐  │
│  │  Table: operations                │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │ id                          │  │  │
│  │  │ operation_type              │  │  │
│  │  │ currency                    │  │  │
│  │  │ amount                      │  │  │
│  │  │ description                 │  │  │
│  │  │ timestamp                   │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  Table: balances                  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │ currency (PRIMARY KEY)      │  │  │
│  │  │ balance                     │  │  │
│  │  │ last_updated                │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## Поток данных при добавлении операции

```
1. Пользователь → "➕ Добавить операцию"
                ↓
2. Бот → "Выберите тип операции"
                ↓
3. Пользователь → "Поступление"
                ↓
4. Бот → "Выберите валюту"
                ↓
5. Пользователь → "USD"
                ↓
6. Бот → "Введите сумму"
                ↓
7. Пользователь → "1000"
                ↓
8. Бот → "Введите описание"
                ↓
9. Пользователь → "Оплата от клиента"
                ↓
10. database.add_operation('Поступление', 'USD', 1000.0, 'Оплата от клиента')
                ↓
11. INSERT INTO operations (...)
                ↓
12. UPDATE balances SET balance = balance + 1000 WHERE currency = 'USD'
                ↓
13. Бот → "✅ Операция добавлена! Баланс USD: 1000.00"
```

## Поток данных при конвертации

```
1. Пользователь → "🔄 Конвертация"
                ↓
2. Бот → "Выберите валюту ИЗ которой конвертируем"
                ↓
3. Пользователь → "USD"
                ↓
4. Бот → "Выберите валюту В которую конвертируем"
                ↓
5. Пользователь → "RUB"
                ↓
6. Бот → "Введите сумму в USD"
                ↓
7. Пользователь → "100"
                ↓
8. Бот → "Введите курс"
                ↓
9. Пользователь → "95.5"
                ↓
10. Расчет: 100 * 95.5 = 9,550 RUB
                ↓
11. database.add_operation('Конвертация', 'USD', -100.0, 'Обмен')
                ↓
12. database.add_operation('Конвертация', 'RUB', 9550.0, 'Обмен')
                ↓
13. Бот → "✅ Конвертация выполнена!"
          "Списано: 100.00 USD"
          "Зачислено: 9,550.00 RUB"
```

## Технологии

- **Python 3.8+** - Язык программирования
- **python-telegram-bot 21.0** - Библиотека для Telegram Bot API
- **SQLite 3** - Встроенная база данных
- **CSV** - Экспорт данных

## Безопасность

- ✅ Локальное хранение данных
- ✅ Нет передачи данных третьим лицам
- ✅ Токен бота в .gitignore
- ✅ Все операции логируются

## Масштабируемость

### Текущая версия
- Один пользователь
- Локальная база данных
- До 100,000 операций

### Возможные улучшения
- Многопользовательский режим
- PostgreSQL/MySQL для больших данных
- Web-интерфейс
- API для интеграции
- Графики и аналитика
- Экспорт в Excel с форматированием
